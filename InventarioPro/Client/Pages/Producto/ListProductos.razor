@page "/ListProductos"
@using InventarioPro.Shared.DTOS.Categoria
@using Microsoft.AspNetCore.Components
@using OfficeOpenXml
@using Radzen
@using System.Collections.Generic
@using System.Linq
@using System.Threading.Tasks
@using InventarioPro.Shared.DTOS.Producto
@using System.IO
@using iText.Kernel.Geom
@using iText.Layout.Borders
@using iText.Layout.Element
@using iText.Pdfa;
@using iText.Kernel.Pdf;
@using iText.Layout;
@inject IJSRuntime jsruntime;
@inject HttpClient Http;

@inject Radzen.DialogService DialogService

<PageTitle>Inventario de Productos</PageTitle>

<div class="header">
    <h2>Inventario de Productos</h2>
    <RadzenButton Text="Agregar Producto" Click="OpenAddProductDialog" Style="margin-bottom: 10px;" />
</div>
<div class="filters" style="display: flex; flex-wrap: wrap; margin-bottom: 20px;">
    <div style="display: flex; align-items: center; flex-wrap: wrap; width: 100%; margin-bottom: 10px;">
        <RadzenDropDown @bind-Value="selectedCategory" Data="@categorias" TextProperty="Nombre" ValueProperty="Id" Placeholder="Categoría" Style="margin-right: 10px; flex: 1 1 150px;" />
        <RadzenDropDown @bind-Value="selectedWarehouse" Data="@warehouses" TextProperty="Name" ValueProperty="Id" Placeholder="Almacén" Style="margin-right: 10px; flex: 1 1 150px;" />
        <label style="margin-right: 5px;">Fecha Inicio:</label>
        <RadzenDatePicker @bind-Value=@value1 DateFormat="dd/MM/yyyy" Style="margin-right: 10px; flex: 1 1 150px;" />
        <label style="margin-right: 5px;">Fecha Fin:</label>
        <RadzenDatePicker @bind-Value=@value2 DateFormat="dd/MM/yyyy" Style="margin-right: 10px; flex: 1 1 150px;" />
        <RadzenTextBox @bind-Value="searchTerm" Placeholder="Buscar Producto" Style="flex: 2; min-width: 150px; margin-right: 10px;" />
        <RadzenButton Text="Filtrar" Click="FilterProducts" Style="margin-right: 10px;" />
    </div>
    <div style="display: flex; align-items: center; width: 100%;">
        <RadzenButton Text="Exportar a Excel" Click="exportarExcel" />
        <RadzenButton Text="Exportar a PDF" Click="ExportarPDF" />

    </div>
</div>
<div style="max-height: 450px; overflow-y: auto;">
    <RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" AllowAlternatingRows="true" AllowSorting="true" PageSize="8" AllowPaging="true"
                    Data="@filteredProducts" ColumnWidth="300px" ShowPagingSummary="true" @bind-Value="@selectedProducts">
        <Columns>
            <RadzenDataGridColumn Title="Foto" Width="180px" TextAlign="TextAlign.Center">
                <Template Context="data">
                    <RadzenImage Path="@($"data:image/jpeg;base64,{data.ImagenProducto}")"
                                 class="rz-product-image"
                                 AlternateText="@(data.Nombre)"
                                 Style="width: 60px; height: auto;" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="@nameof(Producto_DTO.Nombre)" Title="Nombre del Producto" Width="190px" />
            <RadzenDataGridColumn Title="Categoría" Width="110px">
                <Template Context="data">
                    @((categorias.FirstOrDefault(c => c.Id == data.CategoriaId)?.Nombre) ?? "Sin Categoría")
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="@nameof(Producto_DTO.FechaCreacion)" Filterable="false" Title="Fecha" Width="120px" FormatString="{0:dd/MM/yyyy}" />
            <RadzenDataGridColumn Property="@nameof(Producto_DTO.Precio)" Title="Precio" FormatString="{0:C}" Width="120px" />
            <RadzenDataGridColumn Property="@nameof(Producto_DTO.Costo)" Title="Costo" FormatString="{0:C}" Width="120px" />
            <RadzenDataGridColumn Property="@nameof(Producto_DTO.Existencia)" Title="Stock" Width="120px" />
            <RadzenDataGridColumn Title="Acciones" Width="120px">
                <Template Context="data">
                    <RadzenButton Text="Editar" Click="() => OpenEditProductDialog(data.Id)" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>

<style>
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    h2 {
        margin: 0;
        font-size: 24px;
    }

    .filters {
        margin-bottom: 20px;
    }
</style>

@code {
    private List<Producto_DTO> products = new List<Producto_DTO>();
    private List<Producto_DTO> filteredProducts = new List<Producto_DTO>();
    private IList<Producto_DTO> selectedProducts;
    private List<Categoria_DTO> categorias = new List<Categoria_DTO>();
    private int? selectedCategory;
    private int? selectedWarehouse;
    DateTime? value1 { get; set; } = DateTime.Today;
    DateTime? value2 { get; set; } = DateTime.Today;
    private string searchTerm;
    public string excel = "";





    protected override async Task OnInitializedAsync()
    {
        categorias = await Http.GetFromJsonAsync<List<Categoria_DTO>>("api/categoria");
        await LoadProducts();
        filteredProducts = products;
    }

    private List<Warehouse> warehouses = new List<Warehouse>
    {
        new Warehouse { Id = 1, Name = "Almacén A" },
        new Warehouse { Id = 2, Name = "Almacén B" },
        new Warehouse { Id = 3, Name = "Almacén C" }
    };

    private async Task LoadProducts()
    {
        products = await Http.GetFromJsonAsync<List<Producto_DTO>>("api/producto/GetProductos");
        filteredProducts = products; 
    }

    private async Task OpenAddProductDialog()
    {
        var newProduct = new Producto_DTO(); 
        var options = new Radzen.DialogOptions { Style = "width: 900px;" };
        var result = await DialogService.OpenAsync<FormProducto>("Agregar Nuevo Producto", new Dictionary<string, object> { { "Product", newProduct } }, options);

        if (result != null)
        {
            products.Add(result);
            await LoadProducts(); 
        }
    }


    private async Task FilterProducts()
    {
        try
        {
            List<Producto_DTO> allProducts = new List<Producto_DTO>();

            if (selectedCategory.HasValue)
            {
                allProducts = await Http.GetFromJsonAsync<List<Producto_DTO>>($"api/producto/GetPorCategoria/{selectedCategory.Value}");
            }
            else
            {
                allProducts = await Http.GetFromJsonAsync<List<Producto_DTO>>("api/producto/GetProductos");
            }

            if (value1.HasValue && value2.HasValue)
            {
                var filteredByDate = await Http.GetFromJsonAsync<List<Producto_DTO>>($"api/producto/FiltrarPorFechas/{value1.Value:yyyy-MM-dd}/{value2.Value:yyyy-MM-dd}");

                filteredProducts = allProducts
                    .Where(p => filteredByDate.Any(fd => fd.Id == p.Id))
                    .ToList();
            }
            else
            {
                filteredProducts = allProducts;
            }

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                filteredProducts = filteredProducts
                    .Where(p => p.Nombre.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                    .ToList();
            }

        }
        catch (HttpRequestException ex)
        {
            filteredProducts = new List<Producto_DTO>();
        }
    }

    private async Task OpenEditProductDialog(int productId)
    {
        // Obtén el producto que deseas editar desde la API
        var response = await Http.GetAsync($"api/producto/GetProductoId/{productId}");

        if (response.IsSuccessStatusCode)
        {
            var productToEdit = await response.Content.ReadFromJsonAsync<Producto_DTO>();

            var options = new Radzen.DialogOptions { Style = "width: 900px;" };
            await DialogService.OpenAsync<FormProducto>("Editar Producto", new Dictionary<string, object> { { "Product", productToEdit } }, options);
        }
        else
        {
            var errorContent = await response.Content.ReadAsStringAsync();
        }
    }



    public void exportarExcel()
    {
        // Verifica si hay productos para exportar
        if (filteredProducts == null || !filteredProducts.Any())
        {
            Console.WriteLine("No hay productos para exportar.");
            return;
        }

        string[] cabecerasTabla = { "Nombre", "Stock", "Fecha Creacion", "Costo", "Precio", "Categoría" };
        string[] propiedadesMostrar = { "Nombre", "Existencia", "FechaCreacion", "Costo", "Precio" };

        using (MemoryStream ms = new MemoryStream())
        {
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;

            using (ExcelPackage ep = new ExcelPackage())
            {
                var worksheet = ep.Workbook.Worksheets.Add("Hoja");

                // Añade las cabeceras
                for (int i = 0; i < cabecerasTabla.Length; i++)
                {
                    worksheet.Column(i + 1).Width = 15;
                    worksheet.Cells[1, i + 1].Value = cabecerasTabla[i];
                }

                // Inicializa valores
                int fila = 2;
                foreach (var item in filteredProducts)
                {
                    int col = 1;

                    // Rellenar las propiedades del producto
                    foreach (string propiedad in propiedadesMostrar)
                    {
                        worksheet.Cells[fila, col].Value = item.GetType().GetProperty(propiedad)?.GetValue(item)?.ToString() ?? "N/A";
                        col++;
                    }

                    // Obtener el nombre de la categoría
                    var categoria = categorias.FirstOrDefault(c => c.Id == item.CategoriaId);
                    worksheet.Cells[fila, col].Value = categoria?.Nombre ?? "Sin Categoría";

                    fila++;
                }

                ep.SaveAs(ms);
                byte[] buffer = ms.ToArray();
                string base64 = Convert.ToBase64String(buffer);
                excel = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + base64;
                jsruntime.InvokeVoidAsync("descargarExcel", excel);
            }
        }
    }
    public void ExportarPDF()
    {
        if (filteredProducts == null || !filteredProducts.Any())
        {
            Console.WriteLine("No hay productos para exportar.");
            return;
        }

        // Datos ficticios de la empresa
        string empresaNombre = "Tech Solutions S.A.";
        string empresaDireccion = "Av. de la Tecnología 123, Ciudad Innovadora";
        string empresaTelefono = "+123 456 7890";
        string empresaEmail = "contacto@techsolutions.com";

        string[] cabecerasTabla = { "Nombre", "Stock", "Fecha Creación", "Costo", "Precio", "Categoría" };
        string[] propiedadesMostrar = { "Nombre", "Existencia", "FechaCreacion", "Costo", "Precio" };

        using (MemoryStream ms = new MemoryStream())
        {
            PdfWriter writer = new PdfWriter(ms);
            using (var pdfDoc = new PdfDocument(writer))
            {
                // Crea el documento PDF
                Document doc = new Document(pdfDoc, PageSize.A4);
                doc.SetMargins(30, 30, 40, 30); // márgenes más amplios para mayor elegancia

                // Encabezado de la empresa con un estilo limpio
                Paragraph empresaInfo = new Paragraph()
                    .Add(new Text(empresaNombre).SetBold().SetFontSize(16).SetFontColor(iText.Kernel.Colors.ColorConstants.BLACK))
                    .Add(new Text("\n" + empresaDireccion).SetFontSize(10).SetFontColor(iText.Kernel.Colors.ColorConstants.GRAY))
                    .Add(new Text("\nTeléfono: " + empresaTelefono).SetFontSize(10).SetFontColor(iText.Kernel.Colors.ColorConstants.GRAY))
                    .Add(new Text("\nEmail: " + empresaEmail).SetFontSize(10).SetFontColor(iText.Kernel.Colors.ColorConstants.GRAY))
                    .SetTextAlignment(iText.Layout.Properties.TextAlignment.LEFT)
                    .SetMarginBottom(20);
                doc.Add(empresaInfo);

                // Título del documento con mayor énfasis
                Paragraph p1 = new Paragraph("Reporte de Inventario de Productos")
                    .SetTextAlignment(iText.Layout.Properties.TextAlignment.CENTER)
                    .SetFontSize(20)
                    .SetBold()
                    .SetFontColor(iText.Kernel.Colors.ColorConstants.BLUE)
                    .SetMarginBottom(10);
                doc.Add(p1);

                // Subtítulo con la fecha actual de la exportación (solo fecha, sin hora)
                Paragraph fechaExportacion = new Paragraph("Fecha de Exportación: " + DateTime.Now.ToString("dd/MM/yyyy"))
                    .SetTextAlignment(iText.Layout.Properties.TextAlignment.RIGHT)
                    .SetFontSize(12)
                    .SetFontColor(iText.Kernel.Colors.ColorConstants.GRAY)
                    .SetMarginBottom(20);
                doc.Add(fechaExportacion);

                // Crear la tabla con bordes visibles
                Table table = new Table(cabecerasTabla.Length, true);
                table.SetWidthPercent(100);
                table.SetMarginBottom(30); // mayor espacio después de la tabla

                // Estilo de cabecera de la tabla (con fondo gris claro y bordes)
                foreach (var cabecera in cabecerasTabla)
                {
                    var headerCell = new Cell().Add(new Paragraph(cabecera))
                        .SetBackgroundColor(iText.Kernel.Colors.ColorConstants.LIGHT_GRAY)
                        .SetTextAlignment(iText.Layout.Properties.TextAlignment.CENTER)
                        .SetBold()
                        .SetFontColor(iText.Kernel.Colors.ColorConstants.DARK_GRAY)
                        .SetPadding(8)
                        .SetBorderTop(new SolidBorder(1)) // Borde superior
                        .SetBorderBottom(new SolidBorder(1)) // Borde inferior
                        .SetBorderLeft(new SolidBorder(1)) // Borde izquierdo
                        .SetBorderRight(new SolidBorder(1)); // Borde derecho
                    table.AddHeaderCell(headerCell);
                }

                // Agregar los productos a la tabla (con bordes)
                foreach (var item in filteredProducts)
                {
                    // Insertar datos de producto
                    foreach (var propiedad in propiedadesMostrar)
                    {
                        var valor = item.GetType().GetProperty(propiedad)?.GetValue(item)?.ToString() ?? "N/A";

                        // Si la propiedad es la fecha de creación, la formateamos correctamente
                        if (propiedad == "FechaCreacion" && DateTime.TryParse(valor, out DateTime fechaCreacion))
                        {
                            valor = fechaCreacion.ToString("dd/MM/yyyy"); // Solo la fecha, sin la hora
                        }

                        var cell = new Cell().Add(new Paragraph(valor))
                            .SetTextAlignment(iText.Layout.Properties.TextAlignment.CENTER)
                            .SetPadding(8)
                            .SetBorderTop(new SolidBorder(1)) // Borde superior
                            .SetBorderBottom(new SolidBorder(1)) // Borde inferior
                            .SetBorderLeft(new SolidBorder(1)) // Borde izquierdo
                            .SetBorderRight(new SolidBorder(1)); // Borde derecho
                        table.AddCell(cell);
                    }

                    // Insertar categoría
                    var categoria = categorias.FirstOrDefault(c => c.Id == item.CategoriaId);
                    var categoriaCell = new Cell().Add(new Paragraph(categoria?.Nombre ?? "Sin Categoría"))
                        .SetTextAlignment(iText.Layout.Properties.TextAlignment.CENTER)
                        .SetPadding(8)
                        .SetBorderTop(new SolidBorder(1)) // Borde superior
                        .SetBorderBottom(new SolidBorder(1)) // Borde inferior
                        .SetBorderLeft(new SolidBorder(1)) // Borde izquierdo
                        .SetBorderRight(new SolidBorder(1)); // Borde derecho
                    table.AddCell(categoriaCell);
                }

                // Agregar la tabla al documento
                doc.Add(table);

                // Pie de página (información adicional de la empresa)
                Paragraph piePagina = new Paragraph()
                    .Add(new Text("Tech Solutions S.A. | Todos los derechos reservados").SetFontSize(8).SetFontColor(iText.Kernel.Colors.ColorConstants.GRAY))
                    .SetTextAlignment(iText.Layout.Properties.TextAlignment.CENTER)
                    .SetFixedPosition(0, 30, PageSize.A4.GetWidth())
                    .SetMarginTop(10);
                doc.Add(piePagina);

                // Cerrar el documento PDF
                doc.Close();
                writer.Close();

                // Convertir a base64
                byte[] buffer = ms.ToArray();
                string base64 = Convert.ToBase64String(buffer);
                string pdf = "data:application/pdf;base64," + base64;

                // Invocar función JavaScript para descargar el archivo PDF
                jsruntime.InvokeVoidAsync("descargarPDF", pdf);
            }
        }
    }
    public class Warehouse
    {
        public int Id { get; set; }
        public string Name { get; set; }
    }
}
